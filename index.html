<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MacroChefBot ‚Äî Men√∫s con Gemini</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Inter',sans-serif; background-color:#f3f4f6; }
    .container { max-width: 900px; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
    .menu-item { animation: fadeIn .5s ease-out forwards; }
    .bg-gradient-turquesa { background-image: linear-gradient(to right,#00b8d4,#00a8c2); }
    .text-gradient-turquesa { background-image: linear-gradient(to right,#00b8d4,#00a8c2); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .fridge-section { background-color:#e0f7fa; border:2px dashed #00b8d4; }
    .option-selector input[type="radio"]:checked + label { background-color:#00b8d4;color:white;box-shadow:0 4px 6px rgba(0,184,212,.3);border-color:#00b8d4 }
    .badge { font-size:.75rem;border:1px solid #c7f5ff;background:#ecfeff;color:#0369a1;padding:.15rem .4rem;border-radius:.35rem }
    .status-dot{width:.6rem;height:.6rem;border-radius:9999px;display:inline-block;margin-right:.35rem}
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center py-10 px-4">
  <div class="container mx-auto p-6 bg-white rounded-2xl shadow-xl border border-gray-200">
    <!-- Header -->
    <div class="flex items-start justify-between mb-6">
      <div>
        <h1 class="text-4xl font-bold"><span class="text-gradient-turquesa">MacroChefBot</span></h1>
        <p class="mt-2 text-lg text-gray-500">Tu chef IA personal: precisi√≥n en macros, variedad en el plato.</p>
      </div>
      <div class="text-right">
        <div class="badge"><span class="status-dot" id="geminiStatusDot" style="background:#f59e0b"></span>Gemini 2.5-Flash (Netlify)</div>
        <div id="geminiStatusMsg" class="text-xs text-gray-500 mt-1">pendiente de primera llamada‚Ä¶</div>
      </div>
    </div>

    <!-- Objetivos -->
    <div class="bg-cyan-50 p-6 rounded-xl mb-6 border border-cyan-200">
      <h2 class="text-2xl font-semibold text-cyan-800 mb-4">Mis objetivos diarios</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div>
          <label for="targetProtein" class="block text-sm font-medium text-cyan-700">Prote√≠na (g)</label>
          <input type="number" id="targetProtein" value="180" class="mt-1 block w-full px-4 py-2 bg-white border border-cyan-300 rounded-lg focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
        </div>
        <div>
          <label for="targetFat" class="block text-sm font-medium text-cyan-700">Grasas (g)</label>
          <input type="number" id="targetFat" value="80" class="mt-1 block w-full px-4 py-2 bg-white border border-cyan-300 rounded-lg focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
        </div>
        <div>
          <label for="targetCarbs" class="block text-sm font-medium text-cyan-700">Carbohidratos (g)</label>
          <input type="number" id="targetCarbs" value="250" class="mt-1 block w-full px-4 py-2 bg-white border border-cyan-300 rounded-lg focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-cyan-700">Calor√≠as (kcal)</label>
          <p id="totalCalories" class="mt-1 block w-full px-4 py-2 bg-cyan-100 font-bold text-lg text-cyan-800 rounded-lg border border-cyan-300">2490</p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div>
          <label for="numMeals" class="block text-sm font-medium text-cyan-700 mb-1">Comidas/d√≠a</label>
          <select id="numMeals" class="mt-1 block w-full px-4 py-2 bg-white border border-cyan-300 rounded-lg focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
            <option value="1">1 comida</option>
            <option value="2">2 comidas</option>
            <option value="3">3 comidas</option>
            <option value="4" selected>4 comidas</option>
            <option value="5">5 comidas</option>
            <option value="6">6 comidas</option>
          </select>
        </div>
        <div>
          <label for="numDaysToPlan" class="block text-sm font-medium text-cyan-700 mb-1">D√≠as a planificar</label>
          <select id="numDaysToPlan" class="mt-1 block w-full px-4 py-2 bg-white border border-cyan-300 rounded-lg focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
            <option value="1">1 d√≠a</option>
            <option value="3">3 d√≠as</option>
            <option value="5">5 d√≠as</option>
            <option value="7" selected>7 d√≠as (semanal)</option>
          </select>
        </div>
        <div>
          <label for="dietaryFilter" class="block text-sm font-medium text-cyan-700 mb-1">Restricciones diet√©ticas</label>
          <input type="text" id="dietaryFilter" value="Ninguna" class="mt-1 block w-full px-4 py-2 bg-white border border-cyan-300 rounded-lg focus:outline-none focus:ring-cyan-500 focus:border-cyan-500" placeholder="p.ej.: sin gluten, l√°cteos, huevo, frutos secos">
        </div>
      </div>

      <button id="generateMenusBtn" class="w-full mt-3 px-6 py-3 border-4 border-white text-base font-medium rounded-xl text-white bg-gradient-turquesa hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 shadow-lg">
        Generar plan semanal (ignorar nevera)
      </button>
    </div>

    <!-- ¬øQu√© tengo en la nevera? -->
    <div class="fridge-section p-6 rounded-xl mb-8">
      <h2 class="text-2xl font-semibold text-cyan-900 mb-3">¬øQu√© tengo en la nevera?</h2>
      <p class="text-sm text-cyan-700 mb-3">Lista tus ingredientes disponibles (ej.: pechuga, br√≥coli, pasta). La IA intentar√° priorizarlos.</p>
      <textarea id="fridgeIngredients" rows="2" placeholder="Ej.: pechuga de pollo, br√≥coli, arroz, aguacate..." class="mt-1 block w-full px-4 py-2 bg-white border border-cyan-400 rounded-lg focus:outline-none focus:ring-cyan-500 focus:border-cyan-500"></textarea>
      <button id="generateFridgeBtn" class="w-full mt-4 px-6 py-3 border-4 border-white text-base font-medium rounded-xl text-white bg-gradient-turquesa hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 shadow-lg">
        Generar plan semanal ¬°con mi nevera!
      </button>
    </div>

    <!-- Men√∫s -->
    <div id="generatedMenus" class="hidden">
      <h2 class="text-2xl font-semibold text-gray-700 mb-4" id="menusTitle">Plan semanal sugerido</h2>
      <div id="menusContainer" class="space-y-8"></div>
    </div>
  </div>

  <script>
    // --- Estado global m√≠nimo y utilidades ---
    let currentPlanData = null;
    window.availableFoods = []; // reservado para futuras versiones

    // UI elements
    const targetProteinInput = document.getElementById('targetProtein');
    const targetFatInput = document.getElementById('targetFat');
    const targetCarbsInput = document.getElementById('targetCarbs');
    const totalCaloriesElement = document.getElementById('totalCalories');
    const generateMenusBtn = document.getElementById('generateMenusBtn');
    const generateFridgeBtn = document.getElementById('generateFridgeBtn');
    const fridgeIngredientsInput = document.getElementById('fridgeIngredients');
    const generatedMenusSection = document.getElementById('generatedMenus');
    const menusContainer = document.getElementById('menusContainer');
    const dietaryFilterInput = document.getElementById('dietaryFilter');
    const numMealsSelector = document.getElementById('numMeals');
    const numDaysToPlanSelector = document.getElementById('numDaysToPlan');
    const menusTitle = document.getElementById('menusTitle');
    const geminiStatusDot = document.getElementById('geminiStatusDot');
    const geminiStatusMsg = document.getElementById('geminiStatusMsg');

    // C√°lculo de kcal
    function calculateCalories() {
      const p = +targetProteinInput.value || 0;
      const f = +targetFatInput.value || 0;
      const c = +targetCarbsInput.value || 0;
      totalCaloriesElement.textContent = Math.round(p*4 + c*4 + f*9).toLocaleString('es-ES');
    }

    // Marcar estado Gemini (verde tras primera respuesta 2xx)
    function markGeminiOk() {
      geminiStatusDot.style.background = '#16a34a';
      geminiStatusMsg.textContent = 'conectado y operativo';
    }
    function markGeminiError(msg) {
      geminiStatusDot.style.background = '#ef4444';
      geminiStatusMsg.textContent = msg || 'error de conexi√≥n';
    }

    // Sanitizaci√≥n algo m√°s robusta del HTML devuelto
    function safeHTML(s = '') {
      // Elimina bloques <script> y atributos on...
      return s
        .replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '')
        .replace(/\son\w+="[^"]*"/gi, '')
        .replace(/\son\w+='[^']*'/gi, '');
    }

    const daysOfWeek = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];

    // Nombres de comidas seg√∫n n√∫mero de ingestas
    function getMealNames(numMeals) {
      switch (numMeals) {
        case 1:
          return ['Comida √∫nica'];
        case 2:
          return ['Almuerzo fuerte','Cena ligera'];
        case 3:
          return ['Desayuno','Comida','Cena'];
        case 4:
          return ['Desayuno','Comida','Cena','Snack'];
        case 5:
          return ['Desayuno','Media ma√±ana','Comida','Merienda','Cena'];
        case 6:
          return ['Desayuno','Media ma√±ana','Comida','Merienda','Cena','Snack noche'];
        default:
          return ['Comida'];
      }
    }

    function buildSimplePlan() {
      const p = +targetProteinInput.value || 0;
      const f = +targetFatInput.value || 0;
      const c = +targetCarbsInput.value || 0;
      const numDays = +numDaysToPlanSelector.value || 7;
      const numMeals = +numMealsSelector.value || 4;

      const baseMealNames = getMealNames(numMeals);

      const plan = { days: [] };
      for (let d = 0; d < numDays; d++) {
        const meals = baseMealNames.map(n => ({
          name: n,
          targetMacros: {
            p: p / baseMealNames.length,
            f: f / baseMealNames.length,
            c: c / baseMealNames.length
          },
          option1: { description:`${n}: propuesta base`, totalMacros:{p:0,f:0,c:0}, foods:[] },
          option2: { description:`Alternativa: ${n}`, totalMacros:{p:0,f:0,c:0}, foods:[] }
        }));
        plan.days.push({ day: daysOfWeek[d % 7], meals });
      }
      return plan;
    }

    function renderPlan(plan) {
      let html = '';
      plan.days.forEach((day, dayIndex) => {
        html += `
        <div class="menu-item bg-white p-6 rounded-xl shadow-lg border border-gray-200">
          <h3 class="text-3xl font-extrabold text-cyan-800 border-b-4 border-cyan-400 pb-2 mb-4">${day.day}</h3>
          <p class="text-sm text-gray-500 mb-4">Objetivo diario: P: ${targetProteinInput.value}g | G: ${targetFatInput.value}g | C: ${targetCarbsInput.value}g</p>
          <div class="space-y-4">
            ${day.meals.map((meal, mealIndex) => {
              const id = `${dayIndex}-${mealIndex}`;
              return `
              <div class="p-4 rounded-lg bg-gray-50 border border-gray-200">
                <h4 class="text-xl font-semibold text-gray-700">${meal.name}
                  <span class="text-sm font-normal text-cyan-600 ml-2">(P: ${meal.targetMacros.p.toFixed(0)}g | G: ${meal.targetMacros.f.toFixed(0)}g | C: ${meal.targetMacros.c.toFixed(0)}g)</span>
                </h4>
                <div class="mt-2 text-gray-600">${meal.option1.description}</div>
                <button id="btn-recipe-${id}-1" data-target-id="recipe-${id}-1-details" class="mt-3 text-xs px-3 py-1 rounded-lg text-white bg-gradient-turquesa hover:opacity-90 transition">
                  Generar Receta IA
                </button>
                <div id="recipe-${id}-1-details"></div>
              </div>`;
            }).join('')}
          </div>
        </div>`;
      });
      menusContainer.innerHTML = html;

      // Conexi√≥n de botones a la IA
      plan.days.forEach((day, di) => {
        day.meals.forEach((meal, mi) => {
          const btn = document.getElementById(`btn-recipe-${di}-${mi}-1`);
          if (btn) {
            btn.addEventListener('click', () => generateRecipeFromAI(di, mi, 1, btn));
          }
        });
      });
    }

    function generateWeeklyPlan(useFridge) {
      const useFridgeFlag = !!useFridge;
      const hasFridgeText = (fridgeIngredientsInput.value || '').trim().length > 0;

      menusContainer.innerHTML = `
        <div class="text-center p-8 bg-white rounded-xl shadow-inner border border-cyan-300">
          <h3 class="text-xl font-semibold text-cyan-700">Calculando plan...</h3>
          <p class="mt-2 text-gray-500 animate-pulse">MacroChefBot est√° optimizando tu semana.</p>
        </div>`;
      generatedMenusSection.classList.remove('hidden');

      if (useFridgeFlag && hasFridgeText) {
        menusTitle.textContent = `Plan de ${+numDaysToPlanSelector.value} d√≠as usando tu nevera`;
      } else {
        menusTitle.textContent = `Plan de ${+numDaysToPlanSelector.value} d√≠as sugerido`;
      }

      const plan = buildSimplePlan();
      currentPlanData = plan;
      renderPlan(plan);
    }

    // --------------- Llamada a Gemini v√≠a Netlify Function ---------------
    async function callGeminiViaNetlify({ prompt, maxTokens = 600 }) {
      const res = await fetch('/.netlify/functions/verifymyth', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ prompt, maxTokens })
      });
      if (!res.ok) {
        const txt = await res.text().catch(()=> '');
        throw new Error(`HTTP ${res.status} ‚Äî ${txt || 'error en funci√≥n'}`);
      }
      const data = await res.json();
      return data.text || '';
    }

    // Generar receta para una comida concreta con IA
    async function generateRecipeFromAI(dayIndex, mealIndex, optionNumber, buttonElement) {
      const recipeDetailsId = buttonElement.getAttribute('data-target-id');
      const recipeDetailsDiv = document.getElementById(recipeDetailsId);
      if (!currentPlanData) {
        recipeDetailsDiv.innerHTML = '<p class="text-center text-red-500 font-semibold">Error: datos del plan no encontrados. Genera el men√∫ de nuevo.</p>';
        return;
      }
      const meal = currentPlanData.days[dayIndex].meals[mealIndex];
      const macros = meal.targetMacros;
      const userFridge = (fridgeIngredientsInput.value || '').trim();
      const dietary = (dietaryFilterInput.value || '').trim();

      const userPrompt = `
Eres MacroChefBot. Genera UNA receta breve y sabrosa en espa√±ol (HTML simple sin <script>, con <h5>, <ul>, <ol>), basada en:
- Comida: "${meal.name}"
- Macros objetivo aproximados: Prote√≠na ${macros.p.toFixed(0)} g; Grasas ${macros.f.toFixed(0)} g; Carbohidratos ${macros.c.toFixed(0)} g.
- Prioriza ingredientes si el usuario indica nevera: ${userFridge || 'no especificado'}.
- Restricciones diet√©ticas: ${dietary || 'ninguna'}.

Devuelve exactamente esta estructura:
<h5>T√≠tulo</h5>
<div class="text-xs text-gray-500">tiempo y dificultad</div>
<h6>Ingredientes</h6>
<ul><li>ingrediente ‚Äî cantidad sugerida</li>...</ul>
<h6>Elaboraci√≥n</h6>
<ol><li>paso corto...</li>...</ol>

Evita afirmaciones sanitarias, omite riesgos y al√©rgenos salvo sustituciones simples. Ajusta cantidades aproximadas para acercarte a los macros.
`.trim();

      buttonElement.textContent = 'ü§ñ Generando con Gemini...';
      buttonElement.disabled = true;
      recipeDetailsDiv.innerHTML = '<p class="text-center text-cyan-700 animate-pulse font-semibold">Creando receta‚Ä¶</p>';

      try {
        const html = await callGeminiViaNetlify({ prompt: userPrompt, maxTokens: 700 });
        recipeDetailsDiv.innerHTML = `<div class="p-4 bg-cyan-100 rounded-lg shadow-inner mt-3 border border-cyan-300">${safeHTML(html)}</div>`;
        markGeminiOk();
        buttonElement.textContent = 'Receta generada (ver)';
      } catch (err) {
        markGeminiError('fall√≥ la llamada');
        recipeDetailsDiv.innerHTML = `<p class="text-center text-red-500 font-semibold">Error de IA: ${safeHTML(err.message)}</p>`;
        buttonElement.textContent = 'Reintentar';
      } finally {
        buttonElement.disabled = false;
      }
    }

    // Eventos b√°sicos
    [targetProteinInput, targetFatInput, targetCarbsInput].forEach(i => i.addEventListener('input', calculateCalories));
    document.addEventListener('DOMContentLoaded', calculateCalories);
    generateMenusBtn.addEventListener('click', () => generateWeeklyPlan(false));
    generateFridgeBtn.addEventListener('click', () => generateWeeklyPlan(true));
  </script>
</body>
</html>
