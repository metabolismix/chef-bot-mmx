<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chef-Bot – Generador de recetas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Inter',sans-serif;}
    .loader{border:4px solid rgba(0,0,0,0.1);border-top-color:#22c55e;border-radius:9999px;width:40px;height:40px;animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .card-shadow{box-shadow:0 20px 25px -5px rgb(0 0 0 / 0.10),0 8px 10px -6px rgb(0 0 0 / 0.10);}
    .fade-in{animation:fade-in 0.25s ease-out;}
    @keyframes fade-in{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:translateY(0);}}
    .badge-pill{border-radius:9999px;padding:0.15rem 0.75rem;font-size:0.75rem;font-weight:600;}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-emerald-50 flex items-center justify-center p-4">

  <main class="w-full max-w-3xl mx-auto">
    <!-- HEADER -->
    <header class="text-center mb-8">
      <div class="flex justify-center mb-4">
        <!-- Icono "Chef" -->
        <div class="h-16 w-16 rounded-2xl bg-gradient-to-br from-emerald-400 to-lime-400 flex items-center justify-center text-white card-shadow">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18v-3a4 4 0 014-4h4a4 4 0 014 4v3M8 10V8a4 4 0 118 0v2M10 18v-2m4 2v-2" />
          </svg>
        </div>
      </div>
      <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight text-emerald-700">Chef-Bot</h1>
      <p class="mt-2 text-slate-600 max-w-xl mx-auto text-sm md:text-base">
        Genera ideas de recetas y planes semanales a partir de los ingredientes que tienes y tus objetivos de forma rápida y estructurada.
      </p>
    </header>

    <!-- FORMULARIO PRINCIPAL -->
    <section class="card-shadow bg-white/90 rounded-2xl border border-emerald-100 p-5 md:p-6 mb-6">
      <form id="chef-form" class="space-y-4">
        <div>
          <label for="ingredients" class="block text-sm font-semibold text-slate-700 mb-1">
            Ingredientes disponibles
          </label>
          <textarea id="ingredients" rows="3"
            class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
            placeholder="Ejemplo: 2 pechugas de pollo, arroz integral, brócoli, aceite de oliva, tomate..."></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="notes" class="block text-sm font-semibold text-slate-700 mb-1">
              Preferencias / restricciones
            </label>
            <textarea id="notes" rows="3"
              class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
              placeholder="Ejemplo: vegetariano, sin lactosa, poco picante, cenas ligeras..."></textarea>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label for="mealType" class="block text-xs font-semibold text-slate-700 mb-1">
                Tipo de comida
              </label>
              <select id="mealType"
                class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                <option value="Comida">Comida</option>
                <option value="Cena">Cena</option>
                <option value="Desayuno">Desayuno</option>
                <option value="Snack">Snack</option>
              </select>
            </div>

            <div>
              <label for="difficulty" class="block text-xs font-semibold text-slate-700 mb-1">
                Dificultad objetivo
              </label>
              <select id="difficulty"
                class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                <option value="Fácil">Fácil</option>
                <option value="Media">Media</option>
                <option value="Avanzada">Avanzada</option>
              </select>
            </div>

            <div>
              <label for="servings" class="block text-xs font-semibold text-slate-700 mb-1">
                Raciones
              </label>
              <input id="servings" type="number" min="1" step="1" value="1"
                class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
            </div>

            <div>
              <label for="targetCalories" class="block text-xs font-semibold text-slate-700 mb-1">
                Calorías objetivo (opcional)
              </label>
              <input id="targetCalories" type="number" min="0" step="10"
                class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                placeholder="Ej. 600">
            </div>
          </div>
        </div>

        <div class="border-t border-slate-200 pt-4 mt-2 grid grid-cols-1 md:grid-cols-[1.2fr,1fr] gap-4 items-start">
          <div class="space-y-2">
            <button id="btn-generate-recipe" type="submit"
              class="w-full inline-flex items-center justify-center rounded-lg bg-gradient-to-r from-emerald-500 to-lime-500 text-white font-semibold text-sm px-4 py-2.5 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-all">
              <span class="mr-1.5">Generar receta</span>
            </button>
            <p class="text-xs text-slate-500">
              Chef-Bot intentará ajustar ingredientes, tiempos y dificultad a lo que has indicado.
            </p>
          </div>

          <div class="space-y-2 bg-emerald-50/80 border border-emerald-100 rounded-xl px-3 py-2.5">
            <div class="flex items-center justify-between mb-1">
              <p class="text-xs font-semibold text-emerald-800">
                Plan semanal rápido (opcional)
              </p>
              <span class="badge-pill bg-white text-emerald-700 border border-emerald-200">
                Beta
              </span>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label for="weekCalories" class="block text-[11px] font-medium text-emerald-900 mb-0.5">
                  Calorías/día aprox.
                </label>
                <input id="weekCalories" type="number" min="0" step="50"
                  class="w-full border border-emerald-200 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                  placeholder="Ej. 2000">
              </div>
              <div>
                <label for="mealsPerDay" class="block text-[11px] font-medium text-emerald-900 mb-0.5">
                  Comidas/día
                </label>
                <input id="mealsPerDay" type="number" min="1" max="6" step="1" value="3"
                  class="w-full border border-emerald-200 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
              </div>
            </div>
            <button id="btn-generate-week" type="button"
              class="w-full inline-flex items-center justify-center rounded-lg bg-white text-emerald-700 border border-emerald-300 font-semibold text-xs px-3 py-2 hover:bg-emerald-100/80 transition-all">
              Generar plan semanal
            </button>
          </div>
        </div>
      </form>
    </section>

    <!-- LOADER -->
    <div id="loader" class="hidden flex items-center justify-center mb-4">
      <div class="loader"></div>
    </div>

    <!-- RESULTADO: RECETA -->
    <section id="recipe-section" class="hidden fade-in mb-4">
      <div class="bg-cyan-50 border border-cyan-100 rounded-2xl p-5 md:p-6 card-shadow">
        <header class="flex flex-col md:flex-row md:items-center md:justify-between mb-3 gap-2">
          <div>
            <p class="text-xs font-semibold text-cyan-700 uppercase tracking-wider mb-1">
              Receta generada (ver)
            </p>
            <h2 id="recipe-title" class="text-xl md:text-2xl font-extrabold text-cyan-900">
              Receta
            </h2>
          </div>
          <div class="flex flex-wrap gap-2 text-xs text-cyan-900">
            <span id="recipe-prep" class="badge-pill bg-cyan-100">
              Preparación: 0 min
            </span>
            <span id="recipe-cook" class="badge-pill bg-cyan-100">
              Cocción: 0 min
            </span>
            <span id="recipe-diff" class="badge-pill bg-cyan-100">
              Dificultad: -
            </span>
          </div>
        </header>

        <p id="recipe-summary" class="text-sm text-cyan-900 mb-4">
          Aquí aparecerá el resumen de la receta.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
          <div>
            <h3 class="font-semibold text-cyan-900 mb-1">
              Ingredientes para esta comida:
            </h3>
            <ul id="recipe-ingredients" class="list-disc list-inside text-sm text-cyan-900 space-y-0.5">
            </ul>
          </div>

          <div>
            <h3 class="font-semibold text-cyan-900 mb-1">
              Elaboración paso a paso:
            </h3>
            <ol id="recipe-steps" class="list-decimal list-inside text-sm text-cyan-900 space-y-0.5">
            </ol>
          </div>
        </div>

        <div id="recipe-warnings-container" class="mt-4 border-t border-cyan-200 pt-3 hidden">
          <h3 class="font-semibold text-red-700 mb-1 text-sm">
            Avisos importantes:
          </h3>
          <ul id="recipe-warnings" class="list-disc list-inside text-sm text-red-700 space-y-0.5">
          </ul>
        </div>

        <div id="recipe-macros" class="mt-3 text-xs text-cyan-900/80 hidden">
          <!-- Relleno solo si llegan macros estimados -->
        </div>
      </div>
    </section>

    <!-- RESULTADO: PLAN SEMANAL -->
    <section id="week-section" class="hidden fade-in mb-2">
      <div class="bg-emerald-50 border border-emerald-100 rounded-2xl p-5 md:p-6 card-shadow">
        <header class="flex flex-col md:flex-row md:items-center md:justify-between mb-3 gap-2">
          <div>
            <p class="text-xs font-semibold text-emerald-700 uppercase tracking-wider mb-1">
              Plan semanal (beta)
            </p>
            <h2 id="week-title" class="text-xl md:text-2xl font-extrabold text-emerald-900">
              Plan semanal
            </h2>
          </div>
        </header>

        <div id="week-days" class="space-y-3 text-sm text-emerald-900">
          <!-- Se rellenará dinámicamente -->
        </div>

        <div id="week-shopping" class="mt-3 text-sm text-emerald-900 hidden">
          <h3 class="font-semibold mb-1">Lista de la compra orientativa:</h3>
          <ul class="list-disc list-inside space-y-0.5"></ul>
        </div>

        <div id="week-tips" class="mt-3 text-sm text-emerald-900 hidden">
          <h3 class="font-semibold mb-1">Consejos generales:</h3>
          <ul class="list-disc list-inside space-y-0.5"></ul>
        </div>
      </div>
    </section>

    <p id="status-message" class="text-xs text-slate-500 text-center mt-1"></p>
  </main>

  <script>
    // ---------- HELPERS ----------
    const $ = (id) => document.getElementById(id);
    const show = (el) => el && el.classList.remove("hidden");
    const hide = (el) => el && el.classList.add("hidden");

    function robustParseJson(text) {
      if (!text || typeof text !== "string") return null;
      let t = text.trim();
      if (!t) return null;

      // Quitar fences ```json ... ```
      if (t.startsWith("```")) {
        t = t.replace(/^```(?:json)?\\s*/i, "").replace(/```$/, "").trim();
      }

      // 1) Intento directo
      try { return JSON.parse(t); } catch {}

      // 2) Si empieza por array, nos quedamos con el primer objeto
      if (t.startsWith("[")) {
        try {
          const arr = JSON.parse(t);
          if (Array.isArray(arr) && arr.length && typeof arr[0] === "object") {
            return arr[0];
          }
        } catch {}
      }

      // 3) Buscar bloque { ... } balanceado
      const start = t.indexOf("{");
      if (start >= 0) {
        let depth = 0, inStr = false, esc = false;
        for (let i = start; i < t.length; i++) {
          const ch = t[i];
          if (inStr) {
            if (esc) { esc = false; }
            else if (ch === "\\\\") { esc = true; }
            else if (ch === '"') { inStr = false; }
          } else {
            if (ch === '"') inStr = true;
            else if (ch === "{") depth++;
            else if (ch === "}") {
              depth--;
              if (depth === 0) {
                const snippet = t.slice(start, i + 1);
                try { return JSON.parse(snippet); } catch {}
                break;
              }
            }
          }
        }
      }
      return null;
    }

    function buildFallbackRecipe(payload) {
      const ingText = (payload.ingredientsText || "").trim();
      const items = ingText
        ? ingText.split(/[,\\n]/).map(x => x.trim()).filter(Boolean)
        : ["Ingredientes que ya tienes a mano"];

      return {
        mode: "recipe",
        recipe_name: "Receta simplificada",
        prep_minutes: 0,
        cook_minutes: 0,
        difficulty: "Fácil",
        servings: payload.servings || 1,
        ingredients: items.map(name => ({
          name,
          quantity_grams: null,
          notes: "",
        })),
        steps: [
          "Prepara una comida sencilla utilizando los ingredientes que ya tienes a mano.",
          "Cuando la configuración del servidor esté corregida, vuelve a intentar generar una receta con IA.",
        ],
        warnings: [
          "La respuesta original del modelo no se ha podido convertir a un JSON válido.",
          "Se ha generado una receta de respaldo para no interrumpir la experiencia de uso.",
        ],
        macro_estimate: {
          calories: null,
          protein_g: null,
          carbs_g: null,
          fat_g: null,
        },
      };
    }

    function normaliseRecipe(obj, payload) {
      if (!obj || typeof obj !== "object") {
        return buildFallbackRecipe(payload);
      }
      if (obj.mode !== "week" && obj.mode !== "recipe") {
        obj.mode = "recipe";
      }
      if (obj.mode === "week") {
        return obj; // se tratará aparte
      }

      const rec = {
        mode: "recipe",
        recipe_name: obj.recipe_name || "Receta sin título",
        prep_minutes: typeof obj.prep_minutes === "number" ? obj.prep_minutes : 0,
        cook_minutes: typeof obj.cook_minutes === "number" ? obj.cook_minutes : 0,
        difficulty: obj.difficulty || "Fácil",
        servings: typeof obj.servings === "number" && obj.servings > 0 ? obj.servings : (payload.servings || 1),
        meal_type: obj.meal_type || (payload.mealType || "Comida"),
        ingredients: Array.isArray(obj.ingredients) ? obj.ingredients : [],
        steps: Array.isArray(obj.steps) ? obj.steps : [],
        meal_summary: obj.meal_summary || "",
        macro_estimate: obj.macro_estimate || {
          calories: null,
          protein_g: null,
          carbs_g: null,
          fat_g: null,
        },
        warnings: Array.isArray(obj.warnings) ? obj.warnings : [],
      };

      if (!rec.ingredients.length || !rec.steps.length) {
        return buildFallbackRecipe(payload);
      }
      return rec;
    }

    function normaliseWeekPlan(obj) {
      if (!obj || typeof obj !== "object") return null;
      if (obj.mode !== "week") return null;

      return {
        mode: "week",
        plan_name: obj.plan_name || "Plan semanal",
        days: Array.isArray(obj.days) ? obj.days : [],
        shopping_list: Array.isArray(obj.shopping_list)
          ? obj.shopping_list
          : [],
        general_tips: Array.isArray(obj.general_tips)
          ? obj.general_tips
          : [],
      };
    }

    // ---------- API CALL ----------
    async function callChefApi(mode, payload) {
      show($("loader"));
      $("status-message").textContent = "";
      try {
        const res = await fetch("/.netlify/functions/verifyMyth", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mode, payload }),
        });

        const raw = await res.text();
        if (!res.ok) {
          throw new Error(`Error en servidor (${res.status}): ${raw}`);
        }

        const data = raw ? JSON.parse(raw) : {};
        const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
        return text;
      } finally {
        hide($("loader"));
      }
    }

    // ---------- RENDER RECETA ----------
    function renderRecipe(recipe) {
      $("recipe-title").textContent = recipe.recipe_name || "Receta";
      $("recipe-prep").textContent = `Preparación: ${recipe.prep_minutes || 0} min`;
      $("recipe-cook").textContent = `Cocción: ${recipe.cook_minutes || 0} min`;
      $("recipe-diff").textContent = `Dificultad: ${recipe.difficulty || "-"}`;

      $("recipe-summary").textContent =
        recipe.meal_summary ||
        "No he podido estructurar la respuesta de la IA, así que te propongo una receta simplificada basada en los ingredientes.";

      const ingUl = $("recipe-ingredients");
      ingUl.innerHTML = "";
      (recipe.ingredients || []).forEach((ing) => {
        const li = document.createElement("li");
        const grams =
          typeof ing.quantity_grams === "number"
            ? `${Math.round(ing.quantity_grams)} g `
            : "";
        li.textContent = `${grams}${ing.name || ""}`.trim();
        ingUl.appendChild(li);
      });

      const stepsOl = $("recipe-steps");
      stepsOl.innerHTML = "";
      (recipe.steps || []).forEach((step) => {
        const li = document.createElement("li");
        li.textContent = step;
        stepsOl.appendChild(li);
      });

      // Avisos
      const warnings = recipe.warnings || [];
      const warnContainer = $("recipe-warnings-container");
      const warnList = $("recipe-warnings");
      warnList.innerHTML = "";
      if (warnings.length) {
        warnings.forEach((w) => {
          const li = document.createElement("li");
          li.textContent = w;
          warnList.appendChild(li);
        });
        show(warnContainer);
      } else {
        hide(warnContainer);
      }

      // Macros (si hay algo)
      const macros = recipe.macro_estimate || {};
      const hasMacros =
        typeof macros.calories === "number" ||
        typeof macros.protein_g === "number" ||
        typeof macros.carbs_g === "number" ||
        typeof macros.fat_g === "number";

      const macrosDiv = $("recipe-macros");
      if (hasMacros) {
        const parts = [];
        if (typeof macros.calories === "number")
          parts.push(`${Math.round(macros.calories)} kcal aprox.`);
        if (typeof macros.protein_g === "number")
          parts.push(`${Math.round(macros.protein_g)} g proteína`);
        if (typeof macros.carbs_g === "number")
          parts.push(`${Math.round(macros.carbs_g)} g hidratos`);
        if (typeof macros.fat_g === "number")
          parts.push(`${Math.round(macros.fat_g)} g grasas`);

        macrosDiv.textContent =
          "Estimación nutricional aproximada (por ración): " +
          parts.join(" · ");
        show(macrosDiv);
      } else {
        hide(macrosDiv);
      }

      show($("recipe-section"));
    }

    // ---------- RENDER PLAN SEMANAL ----------
    function renderWeekPlan(plan) {
      if (!plan) {
        hide($("week-section"));
        return;
      }
      $("week-title").textContent = plan.plan_name || "Plan semanal";

      const daysDiv = $("week-days");
      daysDiv.innerHTML = "";

      (plan.days || []).forEach((day) => {
        const wrapper = document.createElement("div");
        const title = document.createElement("h3");
        title.className = "font-semibold text-emerald-900";
        title.textContent = day.day_name || "Día";
        wrapper.appendChild(title);

        const list = document.createElement("ul");
        list.className = "list-disc list-inside space-y-0.5 mt-1";
        (day.meals || []).forEach((meal) => {
          const li = document.createElement("li");
          li.innerHTML = `<span class="font-semibold">${
            meal.meal_type || ""
          }:</span> ${meal.recipe_name || ""}${
            meal.short_description ? " – " + meal.short_description : ""
          }`;
          list.appendChild(li);
        });
        wrapper.appendChild(list);
        daysDiv.appendChild(wrapper);
      });

      const shopDiv = $("week-shopping");
      const shopUl = shopDiv.querySelector("ul");
      shopUl.innerHTML = "";
      if ((plan.shopping_list || []).length) {
        plan.shopping_list.forEach((item) => {
          const li = document.createElement("li");
          li.textContent = item;
          shopUl.appendChild(li);
        });
        show(shopDiv);
      } else {
        hide(shopDiv);
      }

      const tipsDiv = $("week-tips");
      const tipsUl = tipsDiv.querySelector("ul");
      tipsUl.innerHTML = "";
      if ((plan.general_tips || []).length) {
        plan.general_tips.forEach((tip) => {
          const li = document.createElement("li");
          li.textContent = tip;
          tipsUl.appendChild(li);
        });
        show(tipsDiv);
      } else {
        hide(tipsDiv);
      }

      show($("week-section"));
    }

    // ---------- EVENTOS ----------
    $("chef-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const payload = {
        ingredientsText: $("ingredients").value,
        notes: $("notes").value,
        mealType: $("mealType").value,
        difficulty: $("difficulty").value,
        servings: Number($("servings").value || 1),
        targetCalories: $("targetCalories").value
          ? Number($("targetCalories").value)
          : null,
      };

      try {
        const text = await callChefApi("recipe", payload);
        const parsed = robustParseJson(text);
        const recipe = normaliseRecipe(parsed, payload);
        renderRecipe(recipe);
        $("status-message").textContent = "";
      } catch (err) {
        const fallback = buildFallbackRecipe(payload);
        renderRecipe(fallback);
        $("status-message").textContent =
          "Ha ocurrido un error al llamar al servidor. Se muestra una receta simplificada.";
      }
    });

    $("btn-generate-week").addEventListener("click", async () => {
      const payload = {
        ingredientsText: $("ingredients").value,
        notes: $("notes").value,
        weekCalories: $("weekCalories").value
          ? Number($("weekCalories").value)
          : null,
        mealsPerDay: $("mealsPerDay").value
          ? Number($("mealsPerDay").value)
          : 3,
      };

      try {
        const text = await callChefApi("week", payload);
        const parsed = robustParseJson(text);
        const plan = normaliseWeekPlan(parsed);
        if (!plan) {
          $("status-message").textContent =
            "No he podido estructurar el plan semanal. Se ha generado la receta individual si la has solicitado.";
          hide($("week-section"));
          return;
        }
        renderWeekPlan(plan);
        $("status-message").textContent = "";
      } catch (err) {
        $("status-message").textContent =
          "Ha ocurrido un error al generar el plan semanal. Puedes seguir usando las recetas individuales.";
        hide($("week-section"));
      }
    });
  </script>
</body>
</html>
