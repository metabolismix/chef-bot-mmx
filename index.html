<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chef-Bot | Nutrición Inteligente</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }

    .bg-mmx-gradient { background: linear-gradient(135deg, #00BCC9 0%, #0088A3 100%); }
    .text-mmx-gradient {
      background: linear-gradient(135deg, #00BCC9 0%, #0088A3 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .text-macro-protein { color: #20C29E; }
    .text-macro-fat     { color: #8C44F7; }
    .text-macro-carb    { color: #00A3FF; }

    .bg-macro-protein { background-color: #20C29E; }
    .bg-macro-fat     { background-color: #8C44F7; }
    .bg-macro-carb    { background-color: #00A3FF; }

    .animate-spin-slow { animation: spin 2s cubic-bezier(0.4, 0, 0.2, 1) infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .fade-in { animation: fadeIn .35s ease-out both; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

    .slide-in { animation: slideIn .45s ease-out both; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(18px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>

<body class="bg-[#f8fafc] min-h-screen text-slate-900 overflow-x-hidden">
  <div class="max-w-5xl mx-auto px-6 py-12 md:py-24">

    <!-- HEADER -->
    <header class="text-center mb-20 fade-in">
      <div class="inline-block p-1 px-3 bg-white border border-slate-100 rounded-full shadow-sm mb-6">
        <p class="text-[10px] font-black text-[#0088A3] uppercase tracking-[0.4em]">
          Powered by Gemini 2.5 Flash
        </p>
      </div>

      <h1 class="text-7xl font-black text-mmx-gradient tracking-tighter mb-4">Chef-</h1>

      <p class="text-slate-400 font-bold text-lg max-w-xl mx-auto leading-relaxed">
        Tu nutricionista mediterráneo de precisión y bajo consumo.
      </p>
    </header>

    <!-- CONFIG PANEL -->
    <div class="grid grid-cols-1 gap-10">

      <div class="bg-white rounded-[3.5rem] p-8 md:p-14 shadow-2xl shadow-slate-200/50 border border-white flex flex-col lg:flex-row gap-16 relative overflow-hidden">
        <div class="absolute top-0 right-0 w-64 h-64 bg-cyan-50/50 rounded-full -translate-y-32 translate-x-32 blur-3xl -z-10"></div>

        <!-- MACROS -->
        <div class="flex-1 space-y-10">
          <h2 class="text-[11px] font-black text-slate-800 uppercase tracking-[0.3em] flex items-center">
            <span class="w-2 h-7 bg-mmx-gradient rounded-full mr-4"></span> Objetivos Macros
          </h2>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
            <div class="flex flex-col gap-3">
              <label class="text-[10px] font-black text-slate-400 tracking-[0.2em] ml-2">PROTEÍNA</label>
              <div class="relative">
                <input id="protein" type="number" min="0"
                  class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-[2rem] font-black text-xl focus:border-[#00BCC9] focus:bg-white outline-none transition-all shadow-inner text-macro-protein"
                  value="160" />
                <span class="absolute right-6 top-1/2 -translate-y-1/2 text-[10px] font-black opacity-20">G</span>
              </div>
            </div>

            <div class="flex flex-col gap-3">
              <label class="text-[10px] font-black text-slate-400 tracking-[0.2em] ml-2">GRASAS</label>
              <div class="relative">
                <input id="fat" type="number" min="0"
                  class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-[2rem] font-black text-xl focus:border-[#00BCC9] focus:bg-white outline-none transition-all shadow-inner text-macro-fat"
                  value="70" />
                <span class="absolute right-6 top-1/2 -translate-y-1/2 text-[10px] font-black opacity-20">G</span>
              </div>
            </div>

            <div class="flex flex-col gap-3">
              <label class="text-[10px] font-black text-slate-400 tracking-[0.2em] ml-2">CARBOS</label>
              <div class="relative">
                <input id="carbs" type="number" min="0"
                  class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-[2rem] font-black text-xl focus:border-[#00BCC9] focus:bg-white outline-none transition-all shadow-inner text-macro-carb"
                  value="220" />
                <span class="absolute right-6 top-1/2 -translate-y-1/2 text-[10px] font-black opacity-20">G</span>
              </div>
            </div>
          </div>

          <div class="bg-slate-50 p-8 rounded-[2.5rem] flex flex-col sm:flex-row justify-between items-center gap-6 shadow-inner border border-slate-100">
            <div class="text-center sm:text-left">
              <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Calorías</p>
              <p class="text-4xl font-black text-slate-800">
                <span id="totalCalories">0</span>
                <span class="text-xs font-bold text-slate-300">KCAL</span>
              </p>
            </div>

            <div class="h-3 w-full sm:w-56 bg-slate-200 rounded-full overflow-hidden flex shadow-inner">
              <div id="barProtein" class="h-full bg-macro-protein transition-all duration-700" style="width:0%"></div>
              <div id="barFat"     class="h-full bg-macro-fat     transition-all duration-700" style="width:0%"></div>
              <div id="barCarb"    class="h-full bg-macro-carb    transition-all duration-700" style="width:0%"></div>
            </div>
          </div>
        </div>

        <!-- PREFS -->
        <div class="flex-1 space-y-10">
          <h2 class="text-[11px] font-black text-slate-800 uppercase tracking-[0.3em] flex items-center">
            <span class="w-2 h-7 bg-slate-800 rounded-full mr-4"></span> Preferencias
          </h2>

          <div class="grid grid-cols-2 gap-6">
            <div class="flex flex-col gap-3">
              <label class="text-[10px] font-black text-slate-400 tracking-[0.2em] ml-2">PLATOS / DÍA</label>
              <select id="numMeals"
                class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-[2rem] font-black text-sm focus:border-[#00BCC9] focus:bg-white outline-none transition-all shadow-inner cursor-pointer">
                <option value="2">2 platos</option>
                <option value="3" selected>3 platos</option>
                <option value="4">4 platos</option>
                <option value="5">5 platos</option>
                <option value="6">6 platos</option>
              </select>
            </div>

            <div class="flex flex-col gap-3">
              <label class="text-[10px] font-black text-slate-400 tracking-[0.2em] ml-2">FILTRO</label>
              <input id="dietaryFilter" type="text" placeholder="Ej: Vegano"
                class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-[2rem] font-bold text-sm focus:border-[#00BCC9] focus:bg-white outline-none transition-all shadow-inner" />
            </div>
          </div>

          <div class="space-y-3">
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] ml-2">Nevera</label>
            <textarea id="fridgeIngredients" placeholder="Escribe lo que tienes hoy disponible..."
              class="w-full p-6 bg-slate-50 border-2 border-dashed border-slate-200 rounded-[2.5rem] text-sm font-medium focus:border-[#00BCC9] focus:bg-white outline-none h-28 transition-all resize-none shadow-inner"></textarea>
          </div>
        </div>
      </div>

      <!-- ACTIONS -->
      <div class="flex flex-col sm:flex-row gap-5">
        <button id="btnIdeal"
          class="flex-1 py-7 bg-slate-200 hover:bg-slate-300 text-slate-700 font-black rounded-[2rem] transition-all disabled:opacity-50 text-xs tracking-widest shadow-sm">
          SUGERIR MENÚ IDEAL
        </button>

        <button id="btnFridge"
          class="flex-[2] py-7 bg-mmx-gradient text-white font-black rounded-[2rem] shadow-xl shadow-cyan-200 hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-50 text-xs tracking-[0.2em]">
          COCINAR CON MI NEVERA
        </button>
      </div>

      <!-- ALERT -->
      <div id="alertWrap" class="hidden"></div>

      <!-- USAGE -->
      <div id="usageWrap" class="hidden justify-center gap-6 fade-in">
        <div class="bg-white px-6 py-2 rounded-full shadow-sm border border-slate-100 flex items-center gap-4">
          <span class="text-[10px] font-black text-slate-300 uppercase tracking-tighter">
            Tokens: <span id="usageTokens" class="text-[#0088A3]">0</span>
          </span>
          <div class="w-[1px] h-3 bg-slate-100"></div>
          <span class="text-[10px] font-black text-slate-300 uppercase tracking-tighter">
            Model: <span class="text-slate-800">2.5 Flash</span>
          </span>
        </div>
      </div>

      <!-- RESULTS -->
      <div id="resultsSection" class="hidden space-y-16 slide-in pt-10">
        <div class="text-center">
          <h2 id="planName" class="text-5xl font-black text-slate-800 tracking-tighter mb-4"></h2>
          <div class="w-20 h-1.5 bg-mmx-gradient mx-auto rounded-full shadow-sm"></div>
        </div>

        <div id="mealsWrap" class="grid grid-cols-1 gap-10 max-w-4xl mx-auto"></div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 max-w-5xl mx-auto mt-20">
          <div class="bg-white p-12 rounded-[3.5rem] shadow-xl border border-slate-50 flex flex-col group">
            <h4 class="text-2xl font-black text-slate-800 mb-10 flex justify-between items-center">
              Lista de Compra
              <div class="p-3 bg-cyan-50 rounded-2xl group-hover:rotate-12 transition-transform">
                <svg class="w-6 h-6 text-[#00BCC9]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M16 11V7a4 4 0 118 0m-4 4v2m0 10a4 4 0 01-8 0v-4m0 0a4 4 0 01-8 0M3 12h18"/>
                </svg>
              </div>
            </h4>
            <div id="shoppingWrap" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
          </div>

          <div class="bg-slate-800 p-12 rounded-[3.5rem] text-white shadow-2xl shadow-slate-300 flex flex-col relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -translate-y-10 translate-x-10 blur-2xl"></div>
            <h4 class="text-2xl font-black mb-10 flex justify-between items-center text-cyan-400">
              Tips Chef-
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
              </svg>
            </h4>
            <div id="tipsWrap" class="space-y-5"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- LOADER OVERLAY -->
    <div id="loader"
      class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-md z-[100] flex flex-col items-center justify-center p-6 text-center fade-in">
      <div class="bg-white p-12 rounded-[3rem] shadow-2xl flex flex-col items-center max-w-sm">
        <div class="relative mb-8 w-20 h-20">
          <div class="w-20 h-20 border-[6px] border-slate-100 rounded-[2rem] absolute"></div>
          <div class="w-20 h-20 border-[6px] border-[#00BCC9] rounded-[2rem] absolute border-t-transparent animate-spin-slow"></div>
        </div>
        <h3 class="text-2xl font-black text-slate-800 tracking-tight">Chef- está trabajando</h3>
        <p class="text-slate-400 font-bold uppercase text-[9px] tracking-[0.3em] mt-3">
          Gemini 2.5 Flash Engine
        </p>
      </div>
    </div>

    <!-- FOOTER -->
    <footer class="mt-40 pt-16 border-t border-slate-100 text-center">
      <p class="text-slate-300 text-[10px] font-black uppercase tracking-[0.5em]">
        Chef- 2025 • Arquitectura Nutricional Avanzada
      </p>
    </footer>
  </div>

  <script type="module">
    const API_ENDPOINT = "/.netlify/functions/chef";

    const els = {
      protein: document.getElementById("protein"),
      fat: document.getElementById("fat"),
      carbs: document.getElementById("carbs"),
      numMeals: document.getElementById("numMeals"),
      dietaryFilter: document.getElementById("dietaryFilter"),
      fridgeIngredients: document.getElementById("fridgeIngredients"),

      totalCalories: document.getElementById("totalCalories"),
      barProtein: document.getElementById("barProtein"),
      barFat: document.getElementById("barFat"),
      barCarb: document.getElementById("barCarb"),

      btnIdeal: document.getElementById("btnIdeal"),
      btnFridge: document.getElementById("btnFridge"),

      alertWrap: document.getElementById("alertWrap"),
      usageWrap: document.getElementById("usageWrap"),
      usageTokens: document.getElementById("usageTokens"),

      resultsSection: document.getElementById("resultsSection"),
      planName: document.getElementById("planName"),
      mealsWrap: document.getElementById("mealsWrap"),
      shoppingWrap: document.getElementById("shoppingWrap"),
      tipsWrap: document.getElementById("tipsWrap"),

      loader: document.getElementById("loader"),
    };

    const state = {
      openMeals: new Set(),
      loading: false,
      plan: null,
      usage: null,
    };

    const n = (v) => {
      const x = Number(v);
      if (!Number.isFinite(x)) return 0;
      return Math.max(0, x);
    };

    function calcCalories(p, c, f) {
      return Math.round((p * 4) + (c * 4) + (f * 9));
    }

    function updateCaloriesUI() {
      const p = n(els.protein.value);
      const f = n(els.fat.value);
      const c = n(els.carbs.value);
      const total = calcCalories(p, c, f);

      els.totalCalories.textContent = String(total);

      const wp = total > 0 ? (p * 4 / total) * 100 : 0;
      const wf = total > 0 ? (f * 9 / total) * 100 : 0;
      const wc = total > 0 ? (c * 4 / total) * 100 : 0;

      els.barProtein.style.width = `${wp}%`;
      els.barFat.style.width = `${wf}%`;
      els.barCarb.style.width = `${wc}%`;
    }

    function setLoading(on) {
      state.loading = on;
      els.loader.classList.toggle("hidden", !on);
      els.btnIdeal.disabled = on;
      els.btnFridge.disabled = on;
    }

    function showAlert(message) {
      els.alertWrap.classList.remove("hidden");
      els.alertWrap.innerHTML = `
        <div class="bg-red-50 border-l-4 border-red-500 p-5 rounded-2xl flex items-start justify-between shadow-sm fade-in">
          <div class="flex gap-3">
            <div class="bg-red-500 rounded-full p-1 mt-0.5">
              <svg class="h-4 w-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </div>
            <p class="text-sm text-red-800 font-bold">${escapeHtml(message)}</p>
          </div>
          <button id="alertClose" class="text-red-400 hover:text-red-700 transition-colors text-xl leading-none">&times;</button>
        </div>
      `;
      document.getElementById("alertClose").onclick = () => {
        els.alertWrap.classList.add("hidden");
        els.alertWrap.innerHTML = "";
      };
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderUsage(usage) {
      if (!usage || typeof usage.totalTokenCount !== "number") {
        els.usageWrap.classList.add("hidden");
        return;
      }
      els.usageTokens.textContent = String(usage.totalTokenCount);
      els.usageWrap.classList.remove("hidden");
      els.usageWrap.classList.add("flex");
    }

    function macroCard(label, value, unit, valueClass, barClass) {
      const v = Math.round(Number(value) || 0);
      return `
        <div class="bg-white p-5 rounded-3xl border border-slate-100 flex flex-col items-center shadow-sm hover:shadow-md transition-all group">
          <span class="text-[9px] font-black text-slate-400 uppercase mb-1 tracking-widest group-hover:text-slate-600 transition-colors">${label}</span>
          <div class="flex items-baseline gap-1">
            <span class="text-2xl font-black ${valueClass}">${v}</span>
            <span class="text-[10px] font-bold text-slate-300">${unit}</span>
          </div>
          <div class="w-10 h-1 mt-3 rounded-full bg-slate-50 overflow-hidden">
            <div class="h-full ${barClass}" style="width:100%"></div>
          </div>
        </div>
      `;
    }

    function renderMeals(meals) {
      state.openMeals = new Set(); // reset
      els.mealsWrap.innerHTML = meals.map((meal, idx) => {
        const kcal = Math.round((meal.macros?.protein_g || 0) * 4 + (meal.macros?.carbs_g || 0) * 4 + (meal.macros?.fat_g || 0) * 9);

        return `
          <div class="bg-white border border-slate-100 rounded-[2.5rem] p-6 md:p-8 shadow-sm hover:shadow-xl transition-all duration-500 overflow-hidden group">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-8">
              <div class="flex-1">
                <span class="inline-block px-3 py-1 bg-cyan-50 text-[#0088A3] text-[9px] font-black uppercase tracking-[0.2em] rounded-full mb-3">
                  ${escapeHtml(meal.meal_type || "COMIDA")}
                </span>
                <h4 class="text-2xl font-black text-slate-800 leading-tight">${escapeHtml(meal.recipe_name || "Receta")}</h4>
              </div>

              <button data-meal="${idx}"
                class="toggleMeal shrink-0 px-8 py-3 rounded-2xl font-black text-xs transition-all shadow-sm bg-slate-50 text-slate-600 hover:bg-slate-100">
                VER PREPARACIÓN
              </button>
            </div>

            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
              ${macroCard("Proteína", meal.macros?.protein_g, "g", "text-macro-protein", "bg-macro-protein")}
              ${macroCard("Grasas", meal.macros?.fat_g, "g", "text-macro-fat", "bg-macro-fat")}
              ${macroCard("Carbos", meal.macros?.carbs_g, "g", "text-macro-carb", "bg-macro-carb")}
              ${macroCard("Calorías", kcal, "kcal", "text-slate-800", "bg-slate-200")}
            </div>

            <div id="mealDetails-${idx}" class="hidden mt-8 pt-8 border-t border-slate-50 grid grid-cols-1 md:grid-cols-2 gap-8">
              <div class="space-y-4">
                <h5 class="text-[11px] font-black text-slate-800 uppercase tracking-widest flex items-center gap-3">
                  <span class="w-2 h-2 bg-[#00BCC9] rounded-full shadow-sm shadow-[#00BCC9]"></span> Ingredientes
                </h5>
                <div class="grid grid-cols-1 gap-2">
                  ${(meal.ingredients || []).map((ing) => `
                    <div class="text-xs bg-slate-50/50 p-3 rounded-2xl flex justify-between items-center border border-transparent hover:border-slate-100 hover:bg-white transition-all">
                      <span class="font-bold text-slate-600">${escapeHtml(ing.name || "Ingrediente")}</span>
                      <span class="font-black text-[#0088A3] bg-cyan-50/50 px-2 py-1 rounded-lg">${Number(ing.quantity_grams || 0)}g</span>
                    </div>
                  `).join("")}
                </div>
              </div>

              <div class="space-y-4">
                <h5 class="text-[11px] font-black text-slate-800 uppercase tracking-widest flex items-center gap-3">
                  <span class="w-2 h-2 bg-slate-800 rounded-full"></span> Instrucciones
                </h5>
                <div class="space-y-3">
                  ${(meal.steps || []).map((step, i) => `
                    <div class="flex gap-4 items-start bg-slate-50/30 p-4 rounded-2xl border border-transparent hover:border-slate-100 hover:bg-white transition-all">
                      <span class="shrink-0 w-6 h-6 rounded-xl bg-slate-800 text-white text-[10px] font-black flex items-center justify-center mt-0.5">${i + 1}</span>
                      <p class="text-[12px] text-slate-600 font-medium leading-relaxed">${escapeHtml(step)}</p>
                    </div>
                  `).join("")}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join("");

      // Attach listeners
      document.querySelectorAll(".toggleMeal").forEach((btn) => {
        btn.addEventListener("click", () => {
          const idx = Number(btn.dataset.meal);
          const details = document.getElementById(`mealDetails-${idx}`);
          const isOpen = !details.classList.contains("hidden");

          // toggle
          details.classList.toggle("hidden", isOpen);
          btn.classList.toggle("bg-slate-800", !isOpen);
          btn.classList.toggle("text-white", !isOpen);
          btn.classList.toggle("shadow-lg", !isOpen);
          btn.classList.toggle("bg-slate-50", isOpen);
          btn.classList.toggle("text-slate-600", isOpen);
          btn.textContent = isOpen ? "VER PREPARACIÓN" : "CERRAR RECETA";
          if (!isOpen) details.classList.add("fade-in");
        });
      });
    }

    function renderShopping(list) {
      els.shoppingWrap.innerHTML = (list || []).map((item) => `
        <div class="text-xs font-bold text-slate-600 bg-slate-50/50 p-5 rounded-3xl border border-slate-100 flex items-center gap-4 hover:bg-white hover:shadow-sm transition-all">
          <div class="w-2 h-2 bg-[#00A3FF] rounded-full shadow-sm shadow-blue-200"></div>
          ${escapeHtml(item)}
        </div>
      `).join("");
    }

    function renderTips(list) {
      els.tipsWrap.innerHTML = (list || []).map((tip, i) => `
        <div class="bg-white/5 p-6 rounded-[2rem] border border-white/5 flex gap-5 hover:bg-white/10 transition-all">
          <span class="text-cyan-400 font-black text-xl italic">${i + 1}</span>
          <p class="text-sm font-medium leading-relaxed opacity-90">${escapeHtml(tip)}</p>
        </div>
      `).join("");
    }

    function renderPlan(plan) {
      if (!plan?.days?.[0]?.meals?.length) {
        els.resultsSection.classList.add("hidden");
        return;
      }

      els.planName.textContent = plan.plan_name || "Plan Chef-";
      renderMeals(plan.days[0].meals);
      renderShopping(plan.shopping_list || []);
      renderTips(plan.general_tips || []);

      els.resultsSection.classList.remove("hidden");

      setTimeout(() => {
        els.resultsSection.scrollIntoView({ behavior: "smooth", block: "start" });
      }, 250);
    }

    async function generate(useFridge) {
      const prefs = {
        protein: n(els.protein.value),
        fat: n(els.fat.value),
        carbs: n(els.carbs.value),
        numMeals: n(els.numMeals.value),
        dietaryFilter: String(els.dietaryFilter.value || "").trim(),
        fridgeIngredients: useFridge ? String(els.fridgeIngredients.value || "").trim() : "",
      };

      if (prefs.protein <= 0 || prefs.fat <= 0 || prefs.carbs <= 0) {
        showAlert("Introduce objetivos de macros válidos (mayores que 0).");
        return;
      }

      setLoading(true);
      els.alertWrap.classList.add("hidden");
      els.alertWrap.innerHTML = "";
      els.resultsSection.classList.add("hidden");
      els.usageWrap.classList.add("hidden");

      try {
        const res = await fetch(API_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(prefs),
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          const msg = data?.error || `Error del servidor (${res.status}).`;
          throw new Error(msg);
        }

        state.plan = data.plan;
        state.usage = data.usage;

        renderUsage(state.usage);
        renderPlan(state.plan);

      } catch (e) {
        showAlert(e?.message || "Chef- ha tenido un problema de conexión. Reinténtalo.");
      } finally {
        setLoading(false);
      }
    }

    // Wire inputs
    ["input", "change"].forEach((evt) => {
      els.protein.addEventListener(evt, updateCaloriesUI);
      els.fat.addEventListener(evt, updateCaloriesUI);
      els.carbs.addEventListener(evt, updateCaloriesUI);
    });

    // Wire buttons
    els.btnIdeal.addEventListener("click", () => generate(false));
    els.btnFridge.addEventListener("click", () => generate(true));

    // init
    updateCaloriesUI();
  </script>
</body>
</html>

